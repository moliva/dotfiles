#!/usr/bin/env bash

# current session name
session=$(tmux display-message -p '#S')

# initialize counter and helper functions
tmux set-environment -g PANE_COUNTER 1
get_val='tmux show-environment -g PANE_COUNTER | cut -d '=' -f2'
get_pane_count="tmux list-panes -t \"$session:\$(echo {1} | awk '{ print(substr(\$1, 1, length(\$1) - 1)) }')\" | wc -l"

# increase/decrease with bounds checking
increase="panes=\$($get_pane_count); current=\$($get_val); if ((current < panes)); then tmux set-environment -g PANE_COUNTER \$((current + 1)); fi"
decrease="current=\$($get_val); if ((current > 1)); then tmux set-environment -g PANE_COUNTER \$((current - 1)); fi"

# preview command to show the window pane content
preview_active_pane="preview_command '$session' {}"
preview_indexed_pane="preview_command '$session' {} \$($get_val)"

# other actions
preview_half_page_up='preview-half-page-up'
preview_half_page_down='preview-half-page-down'

help='execute(bat --style plain --language md --paging always << EOF


                        HELP

        ctrl-h
          This help message

        ctrl-i
        ctrl-o
          To change preview for panes in decreasing (ctrl-i) or increasing (ctrl-o) order

        ctrl-a
          To change preview back to active pane

        ctrl-u
        ctrl-d
          Preview half page up or down
EOF)'

# choose window from list of existing windows in session
window=$(tmux list-windows |
  grep -v '(active)' |
  awk '{ print($1, $2, $3, $4) }' |
  fzf \
    --reverse \
    --prompt 'Window > ' \
    --header 'Press `ctrl-h` for help!' \
    --preview-window 80% \
    --tmux center,80%,70% \
    --cycle \
    --preview "$preview_active_pane" \
    --bind "ctrl-h:$help" \
    --bind "ctrl-a:preview($preview_active_pane)" \
    --bind "ctrl-i:execute($decrease)+preview($preview_indexed_pane)" \
    --bind "ctrl-o:execute($increase)+preview($preview_indexed_pane)" \
    --bind "ctrl-u:$preview_half_page_up" \
    --bind "ctrl-d:$preview_half_page_down" |
  awk '{ print substr($1, 1, length($1) - 1) }')

# select window
tmux select-window -t "$window"
